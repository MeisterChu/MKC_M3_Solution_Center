<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>로그인 - 설비관리대장</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="./assets/styles.css" />
    <style>
      body { background:#f5f5f5; margin:0; }
      .login-wrap { max-width: 440px; margin: 48px auto; padding: 0 16px; }
      .login-card {
        background:#fff; border:1px solid #e5e7eb; border-radius:12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06); padding: 24px;
        display:flex; flex-direction:column; gap:16px;
      }
      .login-title { margin:0; font-size:22px; font-weight:700; color:#222; }
      .field { display:flex; flex-direction:column; gap:6px; }
      .field label { font-size:13px; color:#444; font-weight:600; }
      .field input { padding:12px; border:1px solid #ddd; border-radius:8px; font-size:15px; }
      .field input:focus { outline:none; border-color:#0d6efd; }
      .error-text { color:#dc2626; font-size:13px; min-height: 16px; }
      .login-actions { display:flex; gap:8px; justify-content:flex-end; align-items:center; }
      .btn-primary { background:#0d6efd; color:#fff; border:none; padding:12px 16px; border-radius:8px; font-weight:700; cursor:pointer; }
      .btn-primary:disabled { opacity:.7; cursor:not-allowed; }
      .hint { font-size:12px; color:#777; }
    </style>
    <script type="module" src="./assets/auth-guard.js"></script>
  </head>
  <body>
    <header class="topbar" role="banner">
      <div class="brand"><span class="brand-highlight" aria-label="M3 Solution Center 라벨">M3 Solution Center</span></div>
      <div class="actions" role="toolbar" aria-label="상단 도구 모음"></div>
    </header>

    <main class="login-wrap" role="main">
      <div class="login-card" aria-label="로그인 카드">
        <h1 class="login-title">로그인</h1>
        <div class="field">
          <label for="email">이메일</label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
        </div>
        <div class="field">
          <label for="password">비밀번호</label>
          <input id="password" type="password" placeholder="비밀번호" autocomplete="current-password" />
        </div>
        <div id="errorMsg" class="error-text" aria-live="polite"></div>
        <div class="login-actions">
          <span class="hint" id="hint"></span>
          <button id="btnLogin" class="btn-primary" type="button">로그인</button>
        </div>
      </div>
    </main>

    <script type="module">
      import { getFirebaseApp } from './assets/firebase-config.js';
      import { getAuth, setPersistence, browserSessionPersistence, onAuthStateChanged, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
      const app = getFirebaseApp();
      const auth = getAuth(app);
      try { await setPersistence(auth, browserSessionPersistence); } catch (_) {}

      // 로그인 후 항상 설비목록 페이지로 이동
      const redirect = 'list.html';

      const $ = (s) => document.querySelector(s);
      const email = $('#email');
      const password = $('#password');
      const btnLogin = $('#btnLogin');
      const errorMsg = $('#errorMsg');
      const hint = $('#hint');

      function setBusy(on) {
        btnLogin.disabled = !!on;
      }

      function mapAuthError(e) {
        const code = (e && e.code) || '';
        switch (code) {
          case 'auth/invalid-email': return '이메일 형식이 올바르지 않습니다.';
          case 'auth/missing-password': return '비밀번호를 입력해 주세요.';
          case 'auth/user-disabled': return '해당 계정은 비활성화되었습니다. 관리자에게 문의하세요.';
          case 'auth/user-not-found': return '등록되지 않은 계정입니다. 이메일을 확인해 주세요.';
          case 'auth/wrong-password': return '비밀번호가 올바르지 않습니다.';
          case 'auth/invalid-password': return '비밀번호가 올바르지 않습니다.';
          case 'auth/invalid-credential': return '이메일 또는 비밀번호가 올바르지 않습니다.';
          case 'auth/invalid-login-credentials': return '이메일 또는 비밀번호가 올바르지 않습니다.';
          case 'auth/too-many-requests': return '요청이 일시적으로 차단되었습니다. 잠시 후 다시 시도해 주세요.';
          case 'auth/network-request-failed': return '네트워크 오류입니다. 인터넷 연결을 확인해 주세요.';
          case 'auth/operation-not-allowed': return '이메일/비밀번호 로그인이 비활성화되어 있습니다. 관리자에게 문의하세요.';
          case 'auth/unauthorized-domain': return '허용되지 않은 도메인에서의 요청입니다. 관리자에게 문의하세요.';
          case 'auth/invalid-api-key': return 'API 키가 올바르지 않습니다. 관리자에게 문의하세요.';
          default: return '로그인에 실패했습니다. 다시 시도해 주세요.';
        }
      }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          location.replace(redirect);
        }
      });

      async function doLogin() {
        errorMsg.textContent = '';
        const em = (email.value || '').trim();
        const pw = (password.value || '').trim();
        if (!em) { errorMsg.textContent = '이메일을 입력해 주세요.'; email.focus(); return; }
        if (!pw) { errorMsg.textContent = '비밀번호를 입력해 주세요.'; password.focus(); return; }
        setBusy(true);
        try {
          await signInWithEmailAndPassword(auth, em, pw);
          // onAuthStateChanged will redirect
        } catch (e) {
          const msg = mapAuthError(e);
          const code = (e && e.code) ? ` (${e.code})` : '';
          errorMsg.textContent = msg + code;
          setBusy(false);
        }
      }

      btnLogin.addEventListener('click', doLogin);
      password.addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin(); });
      email.addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin(); });

      // Small hint for session persistence
      hint.textContent = '';
    </script>
  </body>
  </html>
